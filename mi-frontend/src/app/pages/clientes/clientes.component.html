<!-- clientes.component.html -->
<div class="clientes-container">
  <h2>Gestión de Clientes</h2>

  <!-- Mensajes de estado -->
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
  </div>

  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
  </div>

  <!-- Botones principales de acción -->
  <div class="main-actions">
    <button class="btn btn-primary" (click)="openCreateModal()">
      Crear Cliente
    </button>
    <button class="btn btn-secondary" (click)="loadClientes()" [disabled]="isLoading">
      {{ isLoading ? 'Cargando...' : 'Ver Todos los Clientes' }}
    </button>
    <button class="btn btn-info" (click)="searchByUser()" [disabled]="isLoading">
      {{ isLoading ? 'Cargando...' : 'Mis Clientes' }}
    </button>
  </div>

  <!-- Formulario de búsqueda -->
  <div class="search-section">
    <h3>Buscar Clientes</h3>
    <form [formGroup]="searchForm" (ngSubmit)="searchByNombre()" class="search-form">
      <div class="search-row">
        <div class="form-group">
          <label for="searchTerm">Buscar por nombre:</label>
          <input
            id="searchTerm"
            type="text"
            formControlName="searchTerm"
            placeholder="Ingrese nombre del cliente..."
            class="form-control"
          />
          <small class="help-text">Busca clientes por nombre - Escribe y presiona Buscar</small>
        </div>
      </div>
      <div class="search-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isLoading">
          {{ isLoading ? 'Buscando...' : 'Buscar' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="resetSearch()" [disabled]="isLoading">
          Limpiar Búsqueda
        </button>
      </div>
    </form>
  </div>

  <!-- Lista de clientes -->
  <div class="list-section">
    <h3>
      {{ 
        searchMode === 'all' ? 'Todos los Clientes' :
        searchMode === 'nombre' ? 'Resultados de Búsqueda' :
        'Mis Clientes'
      }} ({{ filteredClientes.length }})
    </h3>

    <div *ngIf="isLoading" class="loading">
      Cargando clientes...
    </div>

    <div *ngIf="!isLoading && filteredClientes.length === 0" class="no-data">
      <div *ngIf="searchMode === 'nombre'">
        No se encontraron clientes que coincidan con la búsqueda
      </div>
      <div *ngIf="searchMode === 'user'">
        No tienes clientes asignados
      </div>
      <div *ngIf="searchMode === 'all'">
        No hay clientes registrados en el sistema
      </div>
    </div>

    <div *ngIf="!isLoading && filteredClientes.length > 0" class="clientes-grid">
      <div *ngFor="let cliente of filteredClientes" class="cliente-card">
        <div class="cliente-info">
          <h4>{{ cliente.nombre }}</h4>
          <p *ngIf="cliente.telefono"><strong>Teléfono:</strong> {{ cliente.telefono }}</p>
          <p *ngIf="cliente.contacto"><strong>Contacto:</strong> {{ cliente.contacto }}</p>
          <p><strong>ID Usuario:</strong> {{ cliente.id_user }}</p>
          <p><strong>ID Cliente:</strong> {{ cliente.id_cliente }}</p>
        </div>
        <div class="cliente-actions">
          <button 
            class="btn btn-warning btn-sm" 
            (click)="openEditModal(cliente)"
            [disabled]="isLoading"
            title="Editar cliente"
          >
            Editar
          </button>
          <button 
            class="btn btn-danger btn-sm" 
            (click)="openDeleteModal(cliente)"
            [disabled]="isLoading"
            title="Eliminar cliente"
          >
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para crear cliente -->
  <app-modal 
    [isOpen]="showCreateModal" 
    [title]="'Crear Nuevo Cliente'"
    [showFooter]="false"
    (closed)="closeCreateModal()">
    
    <form [formGroup]="clienteForm" (ngSubmit)="onCreate()" class="client-form">
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombre *</label>
          <input
            id="nombre"
            type="text"
            formControlName="nombre"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('nombre')"
            placeholder="Nombre completo del cliente"
          />
          <div *ngIf="isFieldInvalid('nombre')" class="error-message">
            {{ getFieldError('nombre') }}
          </div>
        </div>

        <div class="form-group">
          <label for="telefono">Teléfono</label>
          <input
            id="telefono"
            type="text"
            formControlName="telefono"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('telefono')"
            placeholder="10 dígitos"
          />
          <div *ngIf="isFieldInvalid('telefono')" class="error-message">
            {{ getFieldError('telefono') }}
          </div>
          <small class="form-help">10 dígitos</small>
        </div>

        <div class="form-group">
          <label for="contacto">Contacto</label>
          <input
            id="contacto"
            type="text"
            formControlName="contacto"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('contacto')"
            placeholder="Persona de contacto"
          />
          <div *ngIf="isFieldInvalid('contacto')" class="error-message">
            {{ getFieldError('contacto') }}
          </div>
          <small class="form-help">Persona de contacto</small>
        </div>
      </div>

      <div class="form-actions">
        <button 
          type="submit" 
          class="btn btn-primary" 
          [disabled]="isLoading || clienteForm.invalid"
        >
          {{ isLoading ? 'Creando...' : 'Crear Cliente' }}
        </button>
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="closeCreateModal()"
          [disabled]="isLoading"
        >
          Cancelar
        </button>
      </div>
    </form>
  </app-modal>

  <!-- Modal para editar cliente -->
  <app-modal 
    [isOpen]="showEditModal" 
    [title]="'Editar Cliente'"
    [showFooter]="false"
    (closed)="closeEditModal()">
    
    <form [formGroup]="clienteForm" (ngSubmit)="onUpdate()" class="client-form" *ngIf="selectedCliente">
      <div class="form-row">
        <div class="form-group">
          <label for="edit-nombre">Nombre *</label>
          <input
            id="edit-nombre"
            type="text"
            formControlName="nombre"
            class="form-control"
            readonly
          />
          <small class="form-help">El nombre no se puede modificar</small>
        </div>

        <div class="form-group">
          <label for="edit-telefono">Teléfono</label>
          <input
            id="edit-telefono"
            type="text"
            formControlName="telefono"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('telefono')"
            placeholder="10 dígitos"
          />
          <div *ngIf="isFieldInvalid('telefono')" class="error-message">
            {{ getFieldError('telefono') }}
          </div>
          <small class="form-help">10 dígitos</small>
        </div>

        <div class="form-group">
          <label for="edit-contacto">Contacto</label>
          <input
            id="edit-contacto"
            type="text"
            formControlName="contacto"
            class="form-control"
            [class.is-invalid]="isFieldInvalid('contacto')"
            placeholder="Persona de contacto"
          />
          <div *ngIf="isFieldInvalid('contacto')" class="error-message">
            {{ getFieldError('contacto') }}
          </div>
          <small class="form-help">Persona de contacto</small>
        </div>
      </div>

      <div class="client-info">
        <h4>Información del Cliente</h4>
        <p><strong>ID Cliente:</strong> {{ selectedCliente.id_cliente }}</p>
        <p><strong>ID Usuario:</strong> {{ selectedCliente.id_user }}</p>
      </div>

      <div class="form-actions">
        <button 
          type="submit" 
          class="btn btn-primary" 
          [disabled]="isLoading || clienteForm.invalid"
        >
          {{ isLoading ? 'Actualizando...' : 'Actualizar' }}
        </button>
        <button 
          type="button" 
          class="btn btn-secondary" 
          (click)="closeEditModal()"
          [disabled]="isLoading"
        >
          Cancelar
        </button>
      </div>
    </form>
  </app-modal>

  <!-- Modal para eliminar cliente -->
  <app-modal 
    [isOpen]="showDeleteModal" 
    [title]="'Eliminar Cliente'"
    [showFooter]="true"
    (closed)="closeDeleteModal()"
    (confirmed)="onDelete()">
    
    <div *ngIf="selectedCliente">
      <p>¿Estás seguro de que quieres eliminar al cliente <strong>"{{ selectedCliente.nombre }}"</strong>?</p>
      <div class="client-details">
        <p><strong>ID Cliente:</strong> {{ selectedCliente.id_cliente }}</p>
        <p><strong>Teléfono:</strong> {{ selectedCliente.telefono || 'No especificado' }}</p>
        <p><strong>Contacto:</strong> {{ selectedCliente.contacto || 'No especificado' }}</p>
      </div>
      <p class="text-warning">⚠️ Esta acción no se puede deshacer.</p>
    </div>
  </app-modal>
</div>
